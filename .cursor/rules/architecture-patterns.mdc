---
description: "Architecture patterns: Convex for game data; optional service layer for shared logic"
globs: ["**/lib/**/*.ts", "**/lib/**/*.tsx", "**/convex/**/*.ts"]
alwaysApply: false
---

# Architecture Patterns

This project uses **Convex** for game and move data, with an optional service layer for shared logic (e.g. engine validation).

## Game and move data (Convex)

- **Location**: `apps/web/convex/`
- **Schema**: `convex/schema.ts` (games, moves, game_reviews)
- **Functions**: `convex/games.ts` â€“ queries (`getById`, `getMoves`, `list`) and mutations (`create`, `makeMove`)
- **Auth**: Protected functions use `ctx.auth.getUserIdentity()`; identity from Better Auth JWT (see `convex/auth.ts` and `docs/temp/migrate-convex.temp.md`)

**Guidelines:**

- Add new game/move behaviour as Convex queries or mutations
- Use Convex validators (`v.id("games")`, etc.) for args
- Enforce ownership in handlers (e.g. `getUserId(ctx)` then check `game.userId === userId`)
- No Drizzle or repository layer for games/moves; they live only in Convex

## Client usage

- **Location**: Components and hooks under `apps/web/`
- **Pattern**: `useQuery(api.games.getById, { gameId })`, `useMutation(api.games.makeMove)`
- **Real-time**: Convex subscriptions keep data in sync; no polling
- **Provider**: `ConvexClientProvider` + `ConvexBetterAuthProvider` in layout; see `app/convex-client-provider.tsx`

## Optional service layer

- **Location**: `apps/web/lib/services/`
- **Purpose**: Shared, non-Convex logic (e.g. `engine.service.ts` for validating engine moves; runs client-side with Stockfish)
- **Pattern**: Pure functions or small modules; no repository or database access for game data

## Auth (Convex + Better Auth)

- **Location**: Convex Better Auth component (`convex/auth.ts`, `@convex-dev/better-auth`); Next.js `/api/auth/*` proxies to Convex
- **Usage**: Auth data (user, session, account) is stored in Convex. Neon and Drizzle are not used.

## References

- Convex schema and functions: `@apps/web/convex/schema.ts`, `@apps/web/convex/games.ts`
- Convex rules: `@.cursor/rules/convex.mdc`
- Auth and migration: `@docs/temp/migrate-convex.temp.md`
