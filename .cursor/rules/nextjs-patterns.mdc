---
description: "Next.js App Router patterns: Server Components, Client Components, and file conventions"
globs: ["**/app/**/*.tsx", "**/components/**/*.tsx"]
alwaysApply: false
---

# Next.js App Router Patterns

This project uses Next.js 16 with the App Router. Follow these patterns for consistency.

## Component Types

### Server Components (Default)

- **No directive needed** - components are Server Components by default
- **Use for**: Data fetching, static content, SEO-friendly pages
- **Can use**: Convex server-side (e.g. `authServer.fetchAuthQuery` for auth checks), file system, etc.
- **Cannot use**: React hooks, browser APIs, event handlers

**Example:**

```tsx
// app/game/[gameId]/page.tsx
import { api } from "@/convex/_generated/api";
import { authServer, getSession } from "@/lib/auth-server";
import { toGameId } from "@/lib/convex-id";
import { notFound, redirect } from "next/navigation";

export default async function GamePage({ params }: { params: Promise<{ gameId: string }> }) {
  const { gameId } = await params;
  const session = await getSession();
  if (!session) redirect("/login");
  try {
    await authServer.fetchAuthQuery(api.games.getById, { gameId: toGameId(gameId) });
  } catch (error) {
    // handle not found / auth error → notFound() or redirect("/login")
  }
  return <GamePageClientLoader gameId={gameId} initialBoardOrientation="white" />;
}
```

### Client Components

- **Requires**: `"use client"` directive at the top
- **Use for**: Interactivity, hooks, browser APIs, event handlers
- **Can use**: All React features, Convex `useQuery` / `useMutation`, custom hooks
- **Pattern**: Create wrapper components for interactive features

**Example:**

```tsx
// components/game/game-page-client.tsx
"use client";

import { useGame } from "@/lib/hooks/use-game";

export function GamePageClient({ gameId }: { gameId: string }) {
  const { game, moves } = useGame(gameId);
  // ... interactive UI
}
```

## File Naming Conventions

- **Pages**: `page.tsx` (App Router convention)
- **Layouts**: `layout.tsx`
- **Components**: `kebab-case.tsx` (e.g. `game-page-client.tsx`, `move-history-card.tsx`) — repo convention is kebab-case for component filenames.
- **Utilities and hooks**: `kebab-case.ts` (e.g. `use-game.ts`, `convex-id.ts`)
- **Types**: `kebab-case.types.ts` or `types.ts`

## Route Structure

- **Dynamic routes**: `app/game/[gameId]/page.tsx`
- **Route groups**: `app/(auth)/login/page.tsx` (parentheses don't affect URL)
- **API routes**: `app/api/.../route.ts`

## Data Fetching Patterns

### Server Components

- Use Convex server-side where needed (e.g. `authServer.fetchAuthQuery(api.games.getById, ...)` for auth or preflight checks)
- Fetch or validate in page/layout; pass minimal props to Client Components
- See `@apps/web/lib/auth-server.ts` and `@.cursor/rules/architecture-patterns.mdc`

### Client Components

- Use Convex `useQuery` and `useMutation` (e.g. `useQuery(api.games.getById, { gameId })`); data stays in sync via Convex subscriptions
- Use custom hooks like `useGame()` for composed state and loading
- Implement optimistic updates where it improves UX

## Component Organization

```text
components/
  ├── ui/              # ShadCN UI components
  ├── chess/           # Chess-specific components
  ├── game/            # Game-related components
  └── auth/            # Authentication components
```

## Best Practices

1. **Default to Server Components** - Only use Client Components when needed
2. **Minimize Client Component boundaries** - Keep Client Components small and focused
3. **Use path aliases**: `@/components`, `@/lib`, `@repo/chess`, etc.
4. **Type props explicitly** - Use TypeScript interfaces for component props
5. **Extract reusable logic** - Create custom hooks for complex state management
6. **Performance** - For bundle size, streaming, and rendering (e.g. `next/dynamic`, Suspense, conditional rendering), follow the **Vercel React best-practices** skill when relevant.

## References

- Server component example: `@apps/web/app/game/[gameId]/page.tsx`
- Client component example: `@apps/web/components/game/game-page-client.tsx`
- Custom hook example: `@apps/web/lib/hooks/use-game.ts`
- Convex auth/server: `@apps/web/lib/auth-server.ts`, `@apps/web/app/convex-client-provider.tsx`
- Architecture: `@.cursor/rules/architecture-patterns.mdc`
